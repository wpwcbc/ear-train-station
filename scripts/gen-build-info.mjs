import { execSync } from 'node:child_process';
import { writeFileSync, mkdirSync } from 'node:fs';
import { dirname } from 'node:path';

function sh(cmd) {
  return execSync(cmd, { stdio: ['ignore', 'pipe', 'ignore'] }).toString().trim();
}

let commit = 'unknown';
let committedAt = new Date().toISOString();
try {
  commit = sh('git rev-parse --short HEAD');
  committedAt = sh('git log -1 --format=%cI');
} catch {
  // ignore (e.g., no git)
}

// NOTE: We intentionally do NOT include a per-build timestamp.
// Keeping this file stable avoids dirty working trees after `npm run build`.

const out = `// AUTO-GENERATED by scripts/gen-build-info.mjs
export const BUILD_INFO = {
  commit: ${JSON.stringify(commit)},
  committedAt: ${JSON.stringify(committedAt)},
} as const;
`;

const outPath = new URL('../src/buildInfo.ts', import.meta.url);
mkdirSync(dirname(outPath.pathname), { recursive: true });
writeFileSync(outPath, out);
console.log('Generated src/buildInfo.ts', { commit, committedAt });
